<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>CAMMM testing popup on hover</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.8.2/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.8.2/mapbox-gl.js"></script>
    <link rel="stylesheet" href="Styles/UIv2.css">
    <script src="Scripts/JavaScript/sidebar.js"></script>
</head>

<body>
    <!-- testing a sidebar code -->
    <div id="mySidebar" class="sidebar">
    </div>

    <div id="main">
        <div id="map">
        </div>
        <h1 class="cammm-title">CAMMM</h1>
        <div id="query-dropdown">
            <div class="dropdown"><button class="dropbtn" id="dropbtn">Multimodality</button>
                <div class="dropdown-content" id="dropdown-content"></div>
            </div>
        </div>
    </div>
    <!-- testing a sidebar code -->
    <script>
        var shortURL = 'mapbox://styles/carmela-cucuzzella/';
        mapboxgl.accessToken = 'pk.eyJ1IjoiY2FybWVsYS1jdWN1enplbGxhIiwiYSI6ImNrZThua3M2djF0MmkzMnFodmlncjU1MzUifQ.kQ7CmjkzU5V5-sY7WFkzmg';
        const map = new mapboxgl.Map({
            container: 'map',
            style: shortURL + 'ckzekgdsr001k14qfh7hkmabp',
            center: [-73.624701, 45.525104],
            zoom: 11.44
        });

        function loadNodes() {
            map.on('load', () => {
                map.addSource('clusters', {
                    'type': 'geojson',
                    'data': {
                        'type': 'FeatureCollection',
                        'features': clusterFeatures,
                    }
                });

                map.addSource('hubs', {
                    'type': 'geojson',
                    'data': {
                        'type': 'FeatureCollection',
                        'features': hubFeatures,
                    }
                });

                // Add a layer showing the clusters.
                map.addLayer({
                    'id': 'clusters',
                    'type': 'circle',
                    'source': 'clusters',
                    'paint': {
                        'circle-color': '#f15924',
                        'circle-opacity': 0.5,
                        'circle-radius': 8,
                    }
                }
                );

                // Add a layer showing the hubs.
                map.addLayer({
                    'id': 'hubs',
                    'type': 'circle',
                    'source': 'hubs',
                    'paint': {
                        'circle-color': '#d81b60',
                        'circle-opacity': 0.7,
                        'circle-radius': 12,
                    }
                }
                );

                // Add labels for hubs
                map.addLayer({
                    'id': 'hub-labels',
                    'type': 'symbol',
                    'source': 'hubs',
                    'paint': {
                        // 'text-halo-blur': 1,
                        'text-halo-color': "#f5f5f5",
                        'text-halo-width': 0.5,
                        // 'text-opacity': ['case',
                        //     ['boolean', ['feature-state', 'click'], false],
                        //     1,
                        //     0]
                    },
                    'layout': {
                        'visibility': 'none',
                        'text-field': [
                            'format',
                            ['upcase', ['get', 'Name']],
                            { 'font-scale': 0.8 },
                        ],
                        'text-font': ['Open Sans Semibold', 'Arial Unicode MS Bold'],
                        'text-offset': [0, 2],
                        'text-max-width': 2,
                        'text-ignore-placement': true,
                    }
                });

                // let clickStateId = null;

                map.on('click', 'clusters', (e) => {
                    // Change the cursor style as a UI indicator.
                    map.getCanvas().style.cursor = 'pointer';
                    map.setPaintProperty('clusters', 'circle-color', '#008080');
                    openSidebar(e.features[0].properties);
                });

                map.on('click', 'hubs', (e) => {
                    // Change the cursor style as a UI indicator.
                    map.getCanvas().style.cursor = 'pointer';
                    map.setPaintProperty('hubs', 'circle-color', '#000000');
                    map.setLayoutProperty('hub-labels', 'visibility', 'visible');
                    // if (e.features.length > 0) {
                    //     clickStateId = e.features[0].id;
                    // if (clickStateId !== null) {
                    // map.setFeatureState(
                    //     { source: 'hubs', sourcelayer: 'hub-labels', id: clickStateId },
                    //     { click: false }
                    // );
                    // }
                    // map.setFeatureState(
                    //     { source: 'hubs', sourcelayer: 'hub-labels', id: e.features[0].id },
                    //     { click: true }
                    // );
                    // }

                    map.flyTo({
                        'center': e.features[0].geometry.coordinates, 'zoom': 14, 'pitch': 60,
                        // 'bearing': 90,
                        'speed': 0.2,
                        'curve': 1,
                        'duration': 3000,
                        'essential': true,
                        'easing': function (t) {
                            return t;
                        }
                    });

                    openSidebar(e.features[0].properties);
                });

                map.on('click', (e) => {
                    if (isOpened) {
                        console.log("pop up closed, reverting to original color");
                        map.setPaintProperty('clusters', 'circle-color', '#f15924');
                        map.setPaintProperty('hubs', 'circle-color', '#d81b60');
                        map.setLayoutProperty('hub-labels', 'visibility', 'none');
                        map.flyTo({
                            'center': [-73.624701, 45.525104],
                            'zoom': 11.44, 'pitch': 0,
                            // 'bearing': 90,
                            'speed': 0.2,
                            'curve': 1,
                            'duration': 2000,
                            'essential': true,
                            'easing': function (t) {
                                return t;
                            }
                        });
                    };
                });
            });
        }
        setTimeout(loadNodes, 800);


        // Read features JSON with new version of nodes
        var clusterFeatures = [];
        var hubFeatures = [];
        var obj;
        var a = new XMLHttpRequest();  // This is creating the variable that reads the JSON file
        function readNodes() {
            a.open('GET', "Data/features.geojson", true);  // This is reading the JSON FILE 
            console.log("Reading the popup info file to load JSON");

            a.onreadystatechange = function () {  //When the JSON file is open it starts a function 

                if (this.readyState == 4) {     //When the file is read, code 4, this IF is True
                    obj = JSON.parse(this.responseText);   // This line parses the response text which is a string into a proper JSON 
                    newJson(obj);
                    queryDropDown();
                    clusterFeatures = getClusters();
                    console.log("Cluster Features:\n");
                    console.log(clusterFeatures);
                    hubFeatures = getHubs();
                    console.log("Hub Features:\n");
                    console.log(hubFeatures);
                }
            }

            a.send();        // Closes the XMLHttpRequest   
        }
        setTimeout(readNodes, 700);



    </script>

</body>

</html>