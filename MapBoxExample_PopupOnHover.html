<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>CAMMM testing popup on hover</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.8.2/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.8.2/mapbox-gl.js"></script>
    <script src='https://npmcdn.com/@turf/turf/turf.min.js'></script>
    <link rel="stylesheet" href="Styles/UIv2.css">
    <script src="Scripts/JavaScript/sidebar.js"></script>
</head>

<body>
    <!-- testing a sidebar code -->
    <div id="mySidebar" class="sidebar">
        <!-- <a href="#">About</a>
        <a href="#">Services</a>
        <a href="#">Clients</a>
        <a href="#">Contact</a> -->
    </div>

    <div id="main">
        <div id="map"></div>
        <!-- <button class="openbtn" onclick="openSidebar()">&#9776; Open Sidebar</button> -->
        <h1 class="cammm-title">CAMMM</h1>
    </div>
    <!-- testing a sidebar code -->
    <script>
        var shortURL = 'mapbox://styles/carmela-cucuzzella/';
        mapboxgl.accessToken = 'pk.eyJ1IjoiY2FybWVsYS1jdWN1enplbGxhIiwiYSI6ImNrZThua3M2djF0MmkzMnFodmlncjU1MzUifQ.kQ7CmjkzU5V5-sY7WFkzmg';
        const map = new mapboxgl.Map({
            container: 'map',
            style: shortURL + 'ckzekgdsr001k14qfh7hkmabp',
            center: [-73.624701, 45.525104],
            zoom: 11.44
        });

        function loadClusters() {
            map.on('load', () => {
                map.addSource('clusters', {
                    'type': 'geojson',
                    'data': {
                        'type': 'FeatureCollection',
                        'features': clusterFeatures,
                    }
                });

                map.addSource('hubs', {
                    'type': 'geojson',
                    'data': {
                        'type': 'FeatureCollection',
                        'features': hubFeatures,
                    }
                });

                // Add a layer showing the clusters.
                map.addLayer({
                    'id': 'clusters',
                    'type': 'circle',
                    'source': 'clusters',
                    'paint': {
                        'circle-color': '#f15924',
                        'circle-opacity': 0.5,
                        'circle-radius': 8,
                    }
                }
                );

                // Add a layer showing the hubs.
                map.addLayer({
                    'id': 'hubs',
                    'type': 'circle',
                    'source': 'hubs',
                    'paint': {
                        'circle-color': '#d81b60',
                        'circle-opacity': 0.7,
                        'circle-radius': 12,
                    }
                }
                );

                map.on('click', 'clusters', (e) => {
                    // Change the cursor style as a UI indicator.
                    map.getCanvas().style.cursor = 'pointer';
                    map.setPaintProperty('clusters', 'circle-color', '#008080');

                    var clusterProperties = e.features[0].properties;

                    const description = clusterProperties.Category + " Cluster: " + clusterProperties.Name + "<br>Number of Stops: " + clusterProperties.NumberOfStops + "<br>List of Stops: " + clusterProperties.ListOfStops;
                    const streetview = "<a href=\"" + clusterProperties.URL + "\"  style=\"width=100%; border:0; background-color: #f15924; color: white;\" target:\"_blank\">Street View</a>";

                    openSidebar(description, streetview);
                });

                map.on('click', 'hubs', (e) => {
                    // Change the cursor style as a UI indicator.
                    map.getCanvas().style.cursor = 'pointer';
                    map.setPaintProperty('hubs', 'circle-color', '#000000');

                    var hubProperties = e.features[0].properties;

                    const description = hubProperties.Category + " Hub: " + hubProperties.Name + "<br>Number of Metro Stations: " + hubProperties.NumberOfStations + "<br>List of Metro Stations: " + hubProperties.ListOfStations + "<br>Number of Bus Stops: " + hubProperties.NumberOfStops + "<br>List of Bus Stops: " + hubProperties.ListOfStops;
                    const streetview = "<embed src=\"" + hubProperties.URL + "\" style=\"width=100%; border:0; background-color: #d81b60; color: white;\">";
                    // "<a href=\"" + e.features[0].properties.URL + "\"  style=\"width=100%; border:0; background-color: #d81b60; color: white;\" target:\"_blank\">Street View</a>";

                    openSidebar(description, streetview);
                });

                map.on('click', (e) => {
                    if (isOpened) {
                        console.log("pop up closed, reverting to original color");
                        map.setPaintProperty('clusters', 'circle-color', '#f15924');
                        map.setPaintProperty('hubs', 'circle-color', '#d81b60');
                    };
                });
            });
        }
        setTimeout(loadClusters, 800);


        // Read features JSON with new version of nodes
        var clusterFeatures = [];
        var hubFeatures = [];
        var obj;
        var a = new XMLHttpRequest();  // This is creating the variable that reads the JSON file
        function readNodes() {
            a.open('GET', "Data/features.geojson", true);  // This is reading the JSON FILE 
            console.log("Reading the popup info file to load JSON");

            a.onreadystatechange = function () {  //When the JSON file is open it starts a function 

                if (this.readyState == 4) {     //When the file is read, code 4, this IF is True
                    obj = JSON.parse(this.responseText);   // This line parses the response text which is a string into a proper JSON 
                    newJson(obj);
                    clusterFeatures = getClusters();
                    console.log("Cluster Features:\n");
                    console.log(clusterFeatures);
                    hubFeatures = getHubs();
                    console.log("Hub Features:\n");
                    console.log(hubFeatures);
                }
            }

            a.send();        // Closes the XMLHttpRequest   
        }
        setTimeout(readNodes, 700);



    </script>

</body>

</html>